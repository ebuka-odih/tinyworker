generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  displayName  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cvs           CV[]
  profiles      CandidateProfile[]
  opportunities Opportunity[]
  applications  Application[]
  documents     Document[]

  @@index([createdAt])
}

model CV {
  id            String   @id @default(uuid())
  userId        String
  filename      String
  mimeType      String?
  sizeBytes     Int?
  storagePath   String
  accessToken   String   @unique
  extractedText String?  @db.Text
  keywords      Json?
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CandidateProfile {
  id                   String   @id @default(uuid())
  userId               String
  cvId                 String?

  name                 String?
  titleHeadline        String?
  seniorityGuess       String?
  yearsExperienceGuess Float?

  roles                Json?
  skills               Json?
  toolsStack           Json?
  industries           Json?
  achievements         Json?
  education            Json?
  certifications       Json?
  keywords             Json?
  preferredRoles       Json?
  preferredLocations   Json?
  links                Json?
  redFlags             Json?

  source               String   @default("cv") // cv|intent|mixed
  status               String   @default("draft") // draft|ready

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
}

model Opportunity {
  id           String   @id @default(uuid())
  userId       String
  type         String // job|scholarship|visa
  title        String
  organization String?
  location     String?
  description  String?  @db.Text
  requirements Json?
  link         String?
  deadline     String?
  matchScore   Float?
  source       String   @default("tinyfish")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications Application[]
  documents    Document[]

  @@index([userId, createdAt])
  @@index([type])
}

model Application {
  id            String   @id @default(uuid())
  userId        String
  opportunityId String
  status        String   @default("saved") // saved|preparing|ready|applied|interview|offer|rejected
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([userId, updatedAt])
  @@index([status])
}

model Document {
  id            String   @id @default(uuid())
  userId        String
  opportunityId String?
  type          String // cv|cover_letter|sop
  title         String
  content       String   @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([type])
}

model TelegramTask {
  id                  String   @id @default(uuid())
  chatId              String
  telegramUserId      String?
  telegramUsername    String?
  telegramDisplayName String?
  messageId           String?
  text                String   @db.Text
  status              String   @default("open") // open|done
  source              String   @default("telegram") // telegram|api
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  completedAt         DateTime?

  @@index([chatId, createdAt])
  @@index([status, createdAt])
  @@unique([chatId, messageId])
}

model TelegramReport {
  id                String   @id @default(uuid())
  chatId            String
  message           String   @db.Text
  sentByUserId      String?
  telegramMessageId String?
  createdAt         DateTime @default(now())

  @@index([chatId, createdAt])
}
